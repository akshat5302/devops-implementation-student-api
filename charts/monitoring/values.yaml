loki-stack:
  loki:
    enabled: true
    nodeSelector:
      type: dependent_services
    tolerations:
    - key: "type"
      operator: "Equal"
      value: "dependent_services"
      effect: "NoSchedule"
    image:
      tag: 2.9.3
    readinessProbe:
      httpGet:
        path: /ready
        port: http-metrics
      initialDelaySeconds: 45
    livenessProbe:
      httpGet:
        path: /ready
        port: http-metrics
      initialDelaySeconds: 45
    # Completely disable loki-stack datasource provisioning
    # The datasource ConfigMap will be manually patched after deployment
    datasource:
      enabled: false
    # Persistent volume configuration for log storage
    persistence:
      enabled: true
      storageClassName: standard
      accessModes:
        - ReadWriteOnce
      size: 10Gi
      annotations: {}
    # Configuration for Loki storage
    config:
      schema_config:
        configs:
          - from: "2020-10-24"
            store: boltdb-shipper
            object_store: filesystem
            schema: v11
            index:
              prefix: index_
              period: 24h
      storage_config:
        boltdb_shipper:
          active_index_directory: /loki/boltdb-shipper-active
          cache_location: /loki/boltdb-shipper-cache
          shared_store: filesystem
        filesystem:
          directory: /loki/chunks
      compactor:
        working_directory: /loki/boltdb-shipper-compactor
        shared_store: filesystem
  grafana:
    enabled: false

  promtail:
    enabled: true
    tolerations:
    - key: "type"
      operator: "Equal"
      value: "dependent_services"
      effect: "NoSchedule"
    - key: "type"
      operator: "Equal"
      value: "application"
      effect: "NoSchedule"
    - key: "type"
      operator: "Equal"
      value: "database"
      effect: "NoSchedule"
    config:
      logLevel: info
      serverPort: 3101
      clients:
      - url: http://observability-loki:3100/loki/api/v1/push
      # Kubernetes scraping configuration to collect logs from all pods
      scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        # Keep logs from all namespaces (remove this section to collect from all)
        # To collect only from student-api namespace, uncomment the following:
        # - source_labels: [__meta_kubernetes_namespace]
        #   action: keep
        #   regex: student-api
        # Add namespace label
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        # Add pod name label
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        # Add container name label
        - source_labels: [__meta_kubernetes_pod_container_name]
          target_label: container
        # Add node name label
        - source_labels: [__meta_kubernetes_pod_node_name]
          target_label: node
        # Add app label if available
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: app
        # Set the log path
        - action: replace
          replacement: /var/log/pods/*$1/*.log
          separator: /
          source_labels:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_container_name
          target_label: __path__

kube-prometheus-stack:
  enabled: true
  alertmanager:
    enabled: true
    alertmanagerSpec:
      nodeSelector:
        type: dependent_services
      tolerations:
      - key: "type"
        operator: "Equal"
        value: "dependent_services"
        effect: "NoSchedule"

  grafana:
    enabled: true
    nodeSelector: 
      type: dependent_services
    tolerations:
      - key: "type"
        operator: "Equal"
        value: "dependent_services" 
        effect: "NoSchedule"
    # Let kube-prometheus-stack manage Prometheus datasource (default)
    # Loki datasource will be added manually or via loki-stack (non-default)
    defaultDashboardsEnabled: true

  prometheusOperator:
    enabled: true
    nodeSelector:
      type: dependent_services
    tolerations:
    - key: "type"
      operator: "Equal"
      value: "dependent_services"
      effect: "NoSchedule"

  prometheus:
    enabled: true
    prometheusSpec:
      tolerations:
      - key: "type"
        operator: "Equal"
        value: "dependent_services"
        effect: "NoSchedule"
      nodeSelector:
        type: dependent_services
      additionalScrapeConfigs:
      - job_name: 'static-monitor'
        metrics_path: /probe
        params:
          module: [ http_2xx ] # Look for a HTTP 200 response.
        static_configs:
        - targets:
          - 'http://<student-api-service-name>:3000/api/v1/health' # Kubernetes DNS name for your service
        relabel_configs:
        - source_labels: [ __address__ ]
          target_label: __param_target
        - source_labels: [ __param_target ]
          target_label: instance
        - target_label: __address__
          replacement: "<blackbox-exporter-service-name>:9115" # Blackbox exporter's address
      - job_name: 'app-metrics'
        metrics_path: /metrics
        scrape_interval: 15s
        static_configs:
        - targets:
          - '<student-api-service-name>:3000' # Kubernetes DNS name for your service
        relabel_configs:
        - source_labels: [ __address__ ]
          target_label: instance
        - target_label: application
          replacement: 'student-api'

prometheus-blackbox-exporter:
  enabled: true
  nodeSelector:
    type: dependent_services
  tolerations:
  - key: "type"
    operator: "Equal"
    value: "dependent_services"
    effect: "NoSchedule"
