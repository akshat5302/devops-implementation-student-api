loki-stack:
  loki:
    enabled: true
    nodeSelector:
      type: dependent_services
    tolerations:
    - key: "type"
      operator: "Equal"
      value: "dependent_services"
      effect: "NoSchedule"
    image:
      tag: 2.9.3
    readinessProbe:
      httpGet:
        path: /ready
        port: http-metrics
      initialDelaySeconds: 45
    livenessProbe:
      httpGet:
        path: /ready
        port: http-metrics
      initialDelaySeconds: 45
    datasource:
      jsonData: "{}"
      uid: ""
    # Increase ingestion rate limits to prevent 429 errors
    config:
      limits_config:
        ingestion_rate_mb: 50
        ingestion_burst_size_mb: 100
        max_streams_per_user: 10000
        max_line_size: 256KB
  grafana:
    enabled: false

  promtail:
    enabled: true
    tolerations:
    - key: "type"
      operator: "Equal"
      value: "dependent_services"
      effect: "NoSchedule"
    - key: "type"
      operator: "Equal"
      value: "application"
      effect: "NoSchedule"
    - key: "type"
      operator: "Equal"
      value: "database"
      effect: "NoSchedule"
    config:
      logLevel: info
      serverPort: 3101
      clients:
      - url: http://observability-loki:3100/loki/api/v1/push
      # Kubernetes scraping configuration to collect logs from all pods
      scrape_configs:
      - job_name: kubernetes-pods
        pipeline_stages:
        - cri: {}
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        # Add namespace label for querying logs by namespace
        - source_labels:
          - __meta_kubernetes_namespace
          target_label: namespace
        # Add pod name label
        - source_labels:
          - __meta_kubernetes_pod_name
          target_label: pod
        # Add container name label
        - source_labels:
          - __meta_kubernetes_pod_container_name
          target_label: container
        # Add node name label
        - source_labels:
          - __meta_kubernetes_pod_node_name
          target_label: node_name
        # Add app label from pod labels
        - source_labels:
          - __meta_kubernetes_pod_label_app_kubernetes_io_name
          - __meta_kubernetes_pod_label_app
          - __meta_kubernetes_pod_controller_name
          - __meta_kubernetes_pod_name
          regex: ^;*([^;]+)(;.*)?$
          action: replace
          target_label: app
        # Set the log path
        - action: replace
          replacement: /var/log/pods/$1/*.log
          separator: /
          source_labels:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_container_name
          target_label: __path__

kube-prometheus-stack:
  enabled: true
  alertmanager:
    enabled: true
    alertmanagerSpec:
      nodeSelector:
        type: dependent_services
      tolerations:
      - key: "type"
        operator: "Equal"
        value: "dependent_services"
        effect: "NoSchedule"

  grafana:
    enabled: true
    nodeSelector:
      type: dependent_services
    tolerations:
    - key: "type"
      operator: "Equal"
      value: "dependent_services"
      effect: "NoSchedule"
    # Let kube-prometheus-stack manage Prometheus datasource (default)
    # Loki datasource will be added manually or via loki-stack (non-default)
    defaultDashboardsEnabled: true

  prometheusOperator:
    enabled: true
    nodeSelector:
      type: dependent_services
    tolerations:
    - key: "type"
      operator: "Equal"
      value: "dependent_services"
      effect: "NoSchedule"

  prometheus:
    enabled: true
    prometheusSpec:
      tolerations:
      - key: "type"
        operator: "Equal"
        value: "dependent_services"
        effect: "NoSchedule"
      nodeSelector:
        type: dependent_services
      additionalScrapeConfigs:
      - job_name: 'static-monitor'
        metrics_path: /probe
        params:
          module: [ http_2xx ] # Look for a HTTP 200 response.
        static_configs:
        - targets:
          - 'http://student-crud-api-api.student-api.svc.cluster.local:3000/api/v1/health' # Kubernetes DNS name for your service
        relabel_configs:
        - source_labels: [ __address__ ]
          target_label: __param_target
        - source_labels: [ __param_target ]
          target_label: instance
        - target_label: __address__
          replacement: "observability-prometheus-blackbox-exporter:9115" # Blackbox exporter's address
      - job_name: 'app-metrics'
        metrics_path: /metrics
        scrape_interval: 15s
        static_configs:
        - targets:
          - 'student-crud-api-api.student-api.svc.cluster.local:3000' # Kubernetes DNS name for your service
        relabel_configs:
        - source_labels: [ __address__ ]
          target_label: instance
        - target_label: application
          replacement: 'student-crud-api-api'

prometheus-blackbox-exporter:
  enabled: true
  nodeSelector:
    type: dependent_services
  tolerations:
  - key: "type"
    operator: "Equal"
    value: "dependent_services"
    effect: "NoSchedule"
